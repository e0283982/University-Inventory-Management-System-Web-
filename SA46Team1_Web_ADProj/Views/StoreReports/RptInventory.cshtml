@{
    Layout = null;
}

@{
    ViewBag.Title = "Inventory Valuation Report";
}
<div>
    <div class="row">
        <div class="col-md-6">
            <h5>Inventory Valuation Report</h5>
        </div>
        <div class="col-md-6">
            <div style="float:right">
                <hr />
                <label id="lbl-cost-info" style="font-size: 10pt;"></label>
            </div>       
        </div>
    </div>

    <span>
        <label>Filter by:</label>
        <select id="chosenToggle">
            <option value="all">All</option>
            <option value="item">Item</option>
            <option value="category">Category</option>
        </select>
    </span>
</div>

<div class="row">
    <div class="col-md-6">
        <div>
            <label style="font-size: 10pt;">Item Description: </label>
            @Html.DropDownList("SelectItemDesc", ViewBag.ItemsList as SelectList, new { @class = "form-control", multiple = "multiple", size = "5", id = "selectItemDesc" })
        </div>
    </div>
    <div class="col-md-6">
        <div>
            <label style="font-size: 10pt;">Category: </label>
            @Html.DropDownList("SelectCategory", ViewBag.CategoryList as SelectList, new { @class = "form-control", multiple = "multiple", size = "5", id = "selectCategory" })
        </div>
    </div>   
</div>

<br />

<div class="row">
    <div class="col-md-12">
        <div style="float:right;">
            <span>
                <input class="btn btn-lu-green" id="btn-submit-filter" type="submit" style="font-size: 10pt;" />
            </span>

            <span id="btn-submit-export">
                @Html.ActionLink("Export to PDF", "ExportRptInventory", "StoreReports", null, new { @class = "btn btn-lu-blue", @id = "btn-export-pdf", style = "font-size: 10pt;" })
            </span>
            @*<div>
                <input class="btn btn-lu-green" type="submit" style="font-size: 10pt;" />
            </div>*@
            @*</div>
            </div>
            <div class="col-md-6">
                <div style="float: right; padding-top: 62px;">
                    <span>
                       @* @Html.ActionLink("Export to PDF", "ExportRptInventory", "StoreReports", null, new { @class = "btn btn-lu-blue", style = "font-size: 10pt;" })*@
            @*</span>*@
        </div>
    </div>
</div>
        
<hr />

<table id="dataTable-storeInventoryVal" class="table">
    <thead style="font-size: 10pt;">
        <tr>
            <th>Category</th>
            <th>Item Code</th>
            <th>Description</th>
            <th>Unit of Measure</th>
            <th>Quantity</th>
            <th>Avg Unit Cost ($)</th>
            <th>Total Cost ($)</th>
        </tr>
    </thead>
    <tbody style="font-size: 10pt;"></tbody>
</table>

<script>
    var table;
    var searchItems = [];
    var searchCategories = [];

    $('#btn-submit-export').hide();

    $(document).ready(function () {
        $("#selectCategory").prop('disabled', true);
        $("#selectItemDesc").prop('disabled', true);

        $.ajax({
            url: 'http://localhost:49921/api/Restful/GetRptInventory',
            method: 'get',
            dataType: 'json',
            success: function (data) {
                d = data;

                table = $('#dataTable-storeInventoryVal').DataTable({
                    paging: true,
                    sort: true,
                    search: false,
                    dom: 'lrtip',
                    //scrollY: 200,
                    "iDisplayLength": 4,
                    data: data,
                    columns: [
                        { 'data': 'CategoryName' },
                        { 'data': 'ItemCode' },
                        { 'data': 'Description' },
                        { 'data': 'UoM' },
                        { 'data': 'Quantity' },
                        {
                            'data': 'AvgUnitCost',
                            'render': function (data, type, row) {
                                return parseFloat(Math.round(data * 100) / 100).toFixed(2);;
                            }
                        },
                        {
                            'data': 'TotalCost',
                            'render': function (data, type, row) {
                                return parseFloat(Math.round(data * 100) / 100).toFixed(2);;
                            }
                        }
                    ],
                    drawCallback: function (settings) {

                        $('#btn-submit-filter').on('click', function () {
                            //check if 'all'
                            var filter = $('#chosenToggle').val();

                            if (filter == "all") {
                                table
                                    .search('')
                                    .columns().search('')
                                    .draw();
                                return;
                            }

                            searchItems = [];
                            searchCategories = [];

                            $('#selectItemDesc option:selected').each(function () {
                                searchItems.push($(this).val());
                            });

                            $('#selectCategory option:selected').each(function () {
                                searchCategories.push($(this).text());
                            });

                            searchItems = searchItems.join('|');
                            searchCategories = searchCategories.join('|');

                            if (searchCategories.length > 0) {
                                table
                                    .columns(0)
                                    .search(searchCategories, true, false, true).draw();
                            } else if (searchItems.length > 0) {
                                table
                                    .columns(1)
                                    .search(searchItems, true, false, true).draw();
                            } else {
                                //alert("No item selected.");
                                table
                                    .search('')
                                    .columns().search('')
                                    .draw();
                                $("#lbl-cost-info").text("");

                                return;
                            }

                            var data = table.rows({ filter: 'applied' }).data();

                            var arr = [];
                            for (var i = 0; i < table.rows({ filter: 'applied' }).data().length; i++) {
                                var rowData = data[i];

                                arr.push(JSON.stringify(rowData));
                            }

                            if (arr.length == 0) {
                                //alert("No results found.");
                                $('#btn-submit-export').hide();
                                return;
                            }

                            $.ajax({
                                url: '/StoreReports/ExportRptInventory2',
                                data: JSON.stringify({ arr: arr }),
                                dataType: "json",
                                contentType: 'application/json; charset=utf-8',
                                type: 'POST',
                            });

                            table.draw(false);
                            $('#btn-submit-export').show();

                            var sum = 0;
                            for (var i = 0; i < table.rows({ filter: 'applied' }).data().length; i++) {
                                var rowData = data[i].TotalCost;
                                sum += rowData;
                            }

                            $("#lbl-cost-info").text("Total cost ($): " + sum.toFixed(2));

                        });

                    },
                });
            }
        });
    });

    $('#btn-export-pdf').on('click', function () {
        $('#btn-submit-export').hide();

    });

    $('#chosenToggle').on('change', function (e) {
        var optionSelected = $("option:selected", this);
        var valueSelected = this.value;

        if (valueSelected == "item") {
            $("#selectCategory").val([]);
            $("#selectCategory").prop('disabled', true);
            $("#selectItemDesc").prop('disabled', false);

        } else if (valueSelected == "category") {
            $("#selectItemDesc").val([]);
            $("#selectItemDesc").prop('disabled', true);
            $("#selectCategory").prop('disabled', false);
        } else {
            //clear filter on table
            $("#selectCategory").val([]);
            $("#selectItemDesc").val([]);
            $("#selectItemDesc").prop('disabled', true);
            $("#selectCategory").prop('disabled', true);
        }

        $('#btn-submit-export').hide();
        $("#lbl-cost-info").text("");

    });
</script>